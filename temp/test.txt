/* Data step to extract bookmarks using INDEX functions for debugging */
data bookmarks(keep = titles site page);
    infile "E:\clinstat_dev\XX5\103\Final\esub\bimo\xx445-*.rtf" 
           lrecl=32767 
           truncover 
           end=eof;

    /* Define lengths for character variables */
    length titles site $2000;

    /* Retain variables across iterations */
    retain page temp_listing;

    /* Initialize page number */
    if _n_ = 1 then page = 0;

    /* Loop through each line of the RTF files */
    do while(not eof);
        input;

        /* 
           1. Identify page number by matching the page indicator pattern.
           Each match increments the page count.
        */
        if index(_infile_, '\sb10\sa10\qc\f1\fs20\cf1{\cell}') then do;
            page + 1;
            /* For debugging: Uncomment the next line to see page increments */
            /* put "Page detected: " page= _infile_; */
        end;

        /* 
           2. Identify listing titles by checking if the line contains 'Listing'
        */
        if index(_infile_, 'Listing') > 0 then do;
            /* Extract the content within braces */
            start = index(_infile_, '{') + 1;
            end = index(_infile_, '\cell}');
            if end > start then do;
                temp_listing = substr(_infile_, start, end - start);
                /* For debugging: Uncomment the next line to see listings */
                /* put "Listing detected: " temp_listing=; */
            end;
        end;

        /* 
           3. Identify site and subject by checking if the line contains 'Subjects who were consent - Site'
        */
        if index(_infile_, 'Subjects who were consent - Site') > 0 then do;
            /* Extract the content within braces */
            start = index(_infile_, '{') + 1;
            end = index(_infile_, '\cell}');
            if end > start then do;
                full_subject = substr(_infile_, start, end - start);
                /* Extract site number */
                site_start = index(full_subject, 'Site') + 5; /* 'Site ' is 5 characters */
                site_number = substr(full_subject, site_start);
                site = cats('Site ', site_number);
                
                /* Combine listing and subject to form the full title */
                if temp_listing ne '' then do;
                    titles = cats(temp_listing, ' ', 'Subjects who were consent');
                    output;
                    /* For debugging: Uncomment the next line to see output records */
                    /* put "Output record: " titles= site= page=; */
                end;
            end;
        end;
    end;
run;
