/* Step 1: Import the bookmarks.txt into a SAS dataset */
data bookmarks_raw;
    infile 'E:\clinstat_dev\XX5\103\Final\esub\bimo\bookmarks.txt' dlm='09'x dsd firstobs=1 truncover;
    length text $2000 page 8;
    input text :$2000. page :8.;
    
    /* Determine the hierarchy level based on leading tabs */
    if substr(text, 1, 1) = '	' then do;
        if substr(text, 2, 1) = '	' then level = 3; /* Two tabs */
        else level = 2; /* One tab */
    end;
    else level = 1; /* No tabs */
    
    /* Remove leading tabs for clean text */
    text = compress(text, '	', 'l');
run;

/* Step 2: Process the dataset to prepare for RTF generation */
data bookmarks_processed;
    set bookmarks_raw;
    by page;
    
    /* Initialize variables */
    retain current_page 0;
    
    /* Detect page changes to insert page breaks */
    if page > current_page then do;
        pages_to_add = page - current_page;
        do i = 1 to pages_to_add;
            /* Insert a page break */
            output_page = 1;
            output;
            current_page + 1;
        end;
    end;
    
    /* Output the bookmark entries */
    output_page = 0;
    output;
    
    drop i pages_to_add;
run;

/* Step 3: Generate the RTF file with bookmarks */
data _null_;
    /* Specify the output RTF file path */
    file 'E:\clinstat_dev\XX5\103\Final\esub\bimo\output_bookmarks.rtf' encoding='utf-8';
    
    /* Write the RTF header */
    put '{\rtf1\ansi\deff0';
    put '{\fonttbl{\f0 Arial;}}';
    put '\viewkind4\uc1\pard\sa200\sl276\slmult1\f0\fs24\lang9';
    
    /* Initialize variables to track previous levels */
    retain prev_level 0;
    
    /* Read the processed bookmarks dataset */
    set bookmarks_processed end=eof;
    
    /* Insert page breaks if required */
    if output_page = 1 then do;
        put '\page';
    end;
    
    /* Handle hierarchical indentation */
    indent = repeat('\tab ', level - 1);
    
    /* Create a unique bookmark name by replacing spaces with underscores */
    bookmark_name = compress(text, ' ', 'k');
    
    /* Write the text with bookmarks */
    if level = 1 then do;
        /* Header Bookmark */
        put indent '{\*\bkmkstart ' bookmark_name '}';
        put indent text;
        put indent '{\*\bkmkend ' bookmark_name '}';
    end;
    else if level = 2 then do;
        /* Site Bookmark */
        put indent '{\*\bkmkstart ' bookmark_name '}';
        put indent text;
        put indent '{\*\bkmkend ' bookmark_name '}';
    end;
    else if level = 3 then do;
        /* Listing Bookmark */
        put indent '{\*\bkmkstart ' bookmark_name '}';
        put indent text;
        put indent '{\*\bkmkend ' bookmark_name '}';
    end;
    
    /* Update previous level */
    prev_level = level;
    
    /* Close the RTF document */
    if eof then put '}';
run;

